<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Food Truck — Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 1rem; background:#f7f9fc; }
    .item-card { min-height: 150px; }
    .muted-small { font-size:.85rem; color:#666; }
    #cart { max-height:70vh; overflow:auto; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3">LaPazera — Menu</h1>
      <div class="muted-small">Open API root: <a href="http://127.0.0.1:8000/api/menu/" target="_blank">/api/menu/</a></div>
    </div>
    <div>
      <!-- Logo placeholder: replace src or set in admin later -->
      <img id="logo" src="" alt="Logo placeholder (add later)" style="height:44px">
    </div>
  </div>

  <div class="card mb-3 p-3">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="form-label mb-0 small">Shop ID</label>
        <input id="shop-id" class="form-control form-control-sm" value="1" style="width:90px;">
      </div>
      <div class="col-auto">
        <label class="form-label mb-0 small">Shop lat,lng (optional)</label>
        <input id="shop-lng-lat" class="form-control form-control-sm" placeholder="lat,lng" style="width:220px;">
      </div>
      <div class="col-auto">
        <label class="form-label mb-0 small">&nbsp;</label><br/>
        <button id="load-menu" class="btn btn-sm btn-primary">Load menu</button>
      </div>
      <div class="col text-end muted-small">This demo supports variants & addons if your API returns `variants`/`addons` arrays inside each item.</div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div id="menu" class="row g-3"></div>
    </div>

    <div class="col-md-4">
      <div class="card p-3" id="cart">
        <h5 class="mb-2">Cart</h5>
        <div id="cart-items" class="mb-2"></div>

        <div class="mb-2">
          <label class="form-label small">Referral code</label>
          <input id="ref-code" class="form-control form-control-sm" placeholder="optional">
          <div id="ref-info" class="muted-small mt-1"></div>
        </div>

        <div class="mb-2">
          <div class="form-check">
            <input id="is-delivery" class="form-check-input" type="checkbox">
            <label class="form-check-label small">Delivery (5 km radius)</label>
          </div>
          <div id="delivery-warning" class="text-danger small d-none"></div>
        </div>

        <div class="mb-2">
          <label class="form-label small">Phone</label>
          <input id="phone" class="form-control form-control-sm" placeholder="9999999999">
        </div>
        <div class="mb-2">
          <label class="form-label small">Address</label>
          <input id="address" class="form-control form-control-sm" placeholder="Delivery address">
        </div>

        <div class="mb-2">
          <label class="form-label small">Payment</label>
          <select id="pay-method" class="form-select form-select-sm">
            <option value="online">Online (UPI/Checkout)</option>
            <option value="cash">Cash at shop</option>
          </select>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-2">
          <div><strong>Total:</strong> ₹ <span id="total">0.00</span></div>
          <button id="place-order" class="btn btn-primary btn-sm">Place order</button>
        </div>

        <div id="order-result" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Variant/addon modal -->
<div class="modal fade" id="optionsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 id="optionsTitle">Options</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="variantsArea"></div>
        <hr/>
        <div id="addonsArea"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmOptions" class="btn btn-primary btn-sm">Add to cart</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* CONFIG */
const API_ROOT = 'http://127.0.0.1:8000';
let cart = []; // { item_id, variant_id|null, addon_ids:[], qty }
let lastMenu = []; // raw menu items
let shopCoords = null; // {lat, lng}
const SHOP_RADIUS_KM = 5;

/* UTIL */
function el(tag, cls=''){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* LOAD MENU */
async function loadMenu(){
  const menuDiv = document.getElementById('menu');
  menuDiv.innerHTML = '<div class="col-12">Loading…</div>';
  try {
    const res = await fetch(`${API_ROOT}/api/menu/items/`);
    const data = await res.json();
    lastMenu = Array.isArray(data) ? data : [];
    if(lastMenu.length===0){ menuDiv.innerHTML = '<div class="col-12">No items yet (add in admin)</div>'; updateTotal(); return; }
    menuDiv.innerHTML = '';
    lastMenu.forEach(it=>{
      const col = el('div','col-md-6');
      const card = el('div','card p-3 item-card');
      const h = el('h5'); h.innerHTML = `${escapeHtml(it.name)} <small class="muted-small">₹${it.base_price}</small>`;
      const desc = el('div','muted-small'); desc.textContent = it.description || '';
      const controls = el('div','text-end mt-2');
      const addBtn = el('button','btn btn-sm btn-primary');
      addBtn.textContent = 'Add';
      addBtn.onclick = ()=> beginAddItem(it);
      controls.appendChild(addBtn);
      card.appendChild(h); card.appendChild(desc);
      // optional image
      if(it.image){
        const img = el('img','img-fluid mb-2');
        img.src = `${API_ROOT}${it.image}`;
        img.alt = it.name || 'item image';
        img.style.maxHeight='120px';
        card.insertBefore(img, h);
      }
      card.appendChild(controls);
      col.appendChild(card);
      menuDiv.appendChild(col);
    });
    updateTotal();
  } catch(e){
    menuDiv.innerHTML = '<div class="text-danger">Menu load failed (see console)</div>';
    console.error(e);
  }
}

/* BEGIN ADD (show variants/addons if present) */
let currentSelecting = null;
function beginAddItem(item){
  currentSelecting = item;
  const vs = document.getElementById('variantsArea');
  const as = document.getElementById('addonsArea');
  vs.innerHTML = ''; as.innerHTML = '';
  document.getElementById('optionsTitle').textContent = item.name;
  // Variants (if present)
  if(item.variants && item.variants.length){
    const g = el('div');
    g.appendChild(el('div','mb-2')).textContent='Choose variant:';
    item.variants.forEach(v=>{
      const id = `variant-${v.id}`;
      const rb = `<div class="form-check"><input class="form-check-input" type="radio" name="variant" id="${id}" value="${v.id}"><label class="form-check-label" for="${id}">${escapeHtml(v.name)} (+₹${v.price_delta})</label></div>`;
      g.insertAdjacentHTML('beforeend', rb);
    });
    vs.appendChild(g);
  } else vs.innerHTML = '<div class="muted-small">No variants</div>';
  // Addons (if present)
  if(item.addons && item.addons.length){
    const g = el('div');
    g.appendChild(el('div','mb-2')).textContent='Addons (optional):';
    item.addons.forEach(a=>{
      const id = `addon-${a.id}`;
      const cb = `<div class="form-check"><input class="form-check-input" type="checkbox" id="${id}" value="${a.id}"><label class="form-check-label" for="${id}">${escapeHtml(a.name)} (+₹${a.price})</label></div>`;
      g.insertAdjacentHTML('beforeend', cb);
    });
    as.appendChild(g);
  } else as.innerHTML = '<div class="muted-small">No addons</div>';
  const modal = new bootstrap.Modal(document.getElementById('optionsModal'));
  modal.show();
}

/* CONFIRM OPTIONS */
document.getElementById('confirmOptions').addEventListener('click', ()=>{
  const item = currentSelecting;
  if(!item) return;
  const variantEl = document.querySelector('input[name="variant"]:checked');
  const variant_id = variantEl ? Number(variantEl.value) : null;
  const addonEls = Array.from(document.querySelectorAll('#addonsArea input[type="checkbox"]:checked')).map(c=>Number(c.value));
  addToCart({ item_id: item.id, variant_id, addon_ids: addonEls, qty: 1 });
  bootstrap.Modal.getInstance(document.getElementById('optionsModal')).hide();
});

/* Cart operations */
function addToCart(line){
  const same = cart.find(c => c.item_id===line.item_id && c.variant_id===line.variant_id && JSON.stringify(c.addon_ids)==JSON.stringify(line.addon_ids));
  if(same){ same.qty += line.qty; } else cart.push(JSON.parse(JSON.stringify(line)));
  renderCart();
}
function renderCart(){
  const wrap = document.getElementById('cart-items');
  if(cart.length===0){ wrap.innerHTML = '<div class="muted-small">Cart empty</div>'; updateTotal(); return; }
  wrap.innerHTML = '';
  cart.forEach((c, idx)=>{
    const row = el('div','d-flex align-items-center mb-2');
    const left = el('div','flex-grow-1');
    const item = lastMenu.find(it => it.id===c.item_id) || {name:`Item ${c.item_id}`, base_price:0};
    left.innerHTML = `<div><strong>${escapeHtml(item.name)}</strong> <small class="muted-small">x${c.qty}</small></div>
                      <div class="muted-small">Variant: ${c.variant_id||'-'} Addons: ${(c.addon_ids?.join(',')||'-')}</div>`;
    const ctrl = el('div');
    ctrl.innerHTML = `<button class="btn btn-sm btn-outline-secondary me-1" data-idx="${idx}" data-op="inc">+</button>
                      <button class="btn btn-sm btn-outline-secondary me-1" data-idx="${idx}" data-op="dec">-</button>
                      <button class="btn btn-sm btn-danger" data-idx="${idx}" data-op="del">x</button>`;
    row.appendChild(left); row.appendChild(ctrl);
    wrap.appendChild(row);
  });
  // handlers
  wrap.querySelectorAll('button').forEach(b=>{
    const idx = Number(b.dataset.idx);
    if(b.dataset.op==='inc'){ b.onclick=()=>{ cart[idx].qty++; renderCart(); }; }
    if(b.dataset.op==='dec'){ b.onclick=()=>{ cart[idx].qty--; if(cart[idx].qty<=0) cart.splice(idx,1); renderCart(); }; }
    if(b.dataset.op==='del'){ b.onclick=()=>{ cart.splice(idx,1); renderCart(); }; }
  });
  updateTotal();
}

async function updateTotal(){
  let total = 0;
  // must compute pricing carefully: base_price + variant.price_delta + addon.price
  for(const c of cart){
    const it = lastMenu.find(x=>x.id===c.item_id);
    if(!it) continue;
    let price = Number(it.base_price || 0);
    if(c.variant_id && it.variants){
      const v = it.variants.find(x=>x.id===c.variant_id);
      if(v) price += Number(v.price_delta || 0);
    }
    if(c.addon_ids && it.addons){
      for(const aid of c.addon_ids){
        const a = it.addons.find(x=>x.id===aid);
        if(a) price += Number(a.price || 0);
      }
    }
    total += price * c.qty;
  }
  // simple referral preview (client-only): flat 10 off for code 'A10' (demo). Replace by server validation later.
  const ref = document.getElementById('ref-code').value.trim();
  let refDiscount = 0;
  if(ref){
    // demo rules (client-side): A10 -> Rs10 off, B20 -> Rs20 off, else none
    if(ref.toUpperCase()==='A10'){ refDiscount = 10; document.getElementById('ref-info').textContent='Demo code A10: ₹10 off (client-side preview)'; }
    else if(ref.toUpperCase()==='B20'){ refDiscount = 20; document.getElementById('ref-info').textContent='Demo code B20: ₹20 off (client-side preview)'; }
    else { document.getElementById('ref-info').textContent='Unknown code (server-side validation required)'; }
  } else document.getElementById('ref-info').textContent='';
  const final = Math.max(0, total - refDiscount);
  document.getElementById('total').textContent = final.toFixed(2);
}

/* DELIVERY CHECK */
function toNumberPair(s){
  if(!s) return null;
  const parts = s.split(',').map(x=>x.trim());
  if(parts.length!==2) return null;
  const lat = Number(parts[0]); const lng = Number(parts[1]);
  if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat,lng};
  return null;
}
function distanceKm(lat1, lon1, lat2, lon2){
  const toRad = v => v*Math.PI/180;
  const R = 6371;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
async function checkDelivery(){
  if(!document.getElementById('is-delivery').checked){ document.getElementById('delivery-warning').classList.add('d-none'); return true; }
  // get shop coords from input or global
  const sc = toNumberPair(document.getElementById('shop-lng-lat').value) || shopCoords;
  if(!sc){ document.getElementById('delivery-warning').textContent='Shop coords not set; cannot validate radius.'; document.getElementById('delivery-warning').classList.remove('d-none'); return true; }
  if(!navigator.geolocation){ document.getElementById('delivery-warning').textContent='Geolocation not supported.'; document.getElementById('delivery-warning').classList.remove('d-none'); return false; }
  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const d = distanceKm(pos.coords.latitude, pos.coords.longitude, sc.lat, sc.lng);
      if(d <= SHOP_RADIUS_KM){ document.getElementById('delivery-warning').classList.add('d-none'); resolve(true); }
      else { document.getElementById('delivery-warning').textContent = `You are ${d.toFixed(2)} km away; delivery ${SHOP_RADIUS_KM} km limit.`; document.getElementById('delivery-warning').classList.remove('d-none'); resolve(false); }
    }, err=>{
      document.getElementById('delivery-warning').textContent='Location permission denied.'; document.getElementById('delivery-warning').classList.remove('d-none'); resolve(false);
    });
  });
}

/* PLACE ORDER */
document.getElementById('place-order').addEventListener('click', async ()=>{
  if(cart.length===0){ alert('Cart empty'); return; }
  const ok = await checkDelivery();
  if(!ok) return;
  // build payload
  const payload = {
    shop_id: Number(document.getElementById('shop-id').value || 1),
    phone: document.getElementById('phone').value || '',
    address: document.getElementById('address').value || '',
    is_delivery: document.getElementById('is-delivery').checked,
    customer_name: 'Guest',
    items: cart.map(c=>({ item_id: c.item_id, variant_id: c.variant_id, addon_ids: c.addon_ids, qty: c.qty }))
  };
  // attach referral code (server must validate it)
  const ref = document.getElementById('ref-code').value.trim();
  if(ref) payload.referral_code = ref;
  const payMethod = document.getElementById('pay-method').value;
  try {
    const res = await fetch(`${API_ROOT}/api/orders/order/create/`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if(!res.ok){ document.getElementById('order-result').innerHTML = `<div class="text-danger">Error: ${JSON.stringify(result)}</div>`; return; }
    document.getElementById('order-result').innerHTML = `<div class="text-success">Order created: ${JSON.stringify(result)}</div>`;
    // If online payment chosen -> placeholder: call backend to create payment session / razorpay order
    if(payMethod==='online'){
      // TODO: call backend e.g. POST /api/orders/{{order_id}}/create-payment/ to create Razorpay order id
      // Then open Razorpay checkout here with returned order id.
      alert('Online payment placeholder — integrate Razorpay/Stripe here (I can scaffold this next).');
    }
    cart = []; renderCart();
  } catch(e){
    console.error(e); document.getElementById('order-result').innerHTML = '<div class="text-danger">Network error</div>';
  }
});

/* Init event listeners */
document.getElementById('load-menu').addEventListener('click', loadMenu);
document.getElementById('ref-code').addEventListener('input', updateTotal);
document.getElementById('is-delivery').addEventListener('change', ()=>{ document.getElementById('delivery-warning').classList.add('d-none'); });
loadMenu();
</script>
</body>
</html>
